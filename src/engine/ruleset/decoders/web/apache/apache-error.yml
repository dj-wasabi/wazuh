name: decoder/apache-error/0

sources:
  - decoder/queue-syslog/0
  - decoder/queue-localfile/0

metadata:
  module: apache error
  title: Apache HTTP Server error logs decoder
  description: Decoder for Apache HTTP Server
  compatibility: Apache HTTP Server v2.4
  author:
    name: Wazuh Inc. info@wazuh.com
    date: 2022-11-15
  references:
    - https://httpd.apache.org/docs/2.4/custom-error.html

check:
  - event.original: +s_starts/[

parse:
  logpar:
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<~apache.error.module>:<log.level>] [pid <process.pid>:tid <process.thread.id>] <~> [client <source.address>:<source.port>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<~apache.error.module>:<log.level>] [pid <process.pid>:tid <process.thread.id>] [client <source.address>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<~apache.error.module>:<log.level>] [pid <process.pid>] [client <source.address>:<source.port>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<~apache.error.module>:<log.level>] [pid <process.pid>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<log.level>] [client <source.address>:<source.port>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<log.level>] [client <source.address>] <message>"
    - event.original: "[<@timestamp/26\\/Dec\\/2016:18:23:35 +0200>] [<log.level>] <message>"

normalize:
  - check:
      - log.level: +r_match/^(?:emerg|alert|crit|error|warn)$
    map:
      - event.type: +a_append/error
  - check:
      - log.level: +r_not_match/^(?:emerg|alert|crit|error|warn)?$
    map:
      - event.type: +a_append/info

  - map:
      - event.category: +a_append/web
      - event.created: $@timestamp
      - event.dataset: apache.error
      - event.kind: event
      - event.module: apache
      - service.type: apache
      - event.category: +a_append/web
      - file.path: "+r_ext/$message/File does not exist: ([^,]+)(,.*)?$"
      - http.request.referrer: "+r_ext/$message/File does not exist: [^,]+, referer: (.*)$"

  - check:
      - source.address: +r_match/((^\s*((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))\s*$)|(^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$))$
    map:
      - source.ip: $source.address

  - check:
      - source.address: +r_not_match/((^\s*((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))\s*$)|(^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$))$
    map:
      - source.domain: $source.address
