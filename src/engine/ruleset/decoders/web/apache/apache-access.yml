name: decoder/apache-access/0

sources:
  - decoder/queue-syslog/0
  - decoder/queue-localfile/0

metadata:
  module: apache access
  title: Apache HTTP Server access logs decoder
  description: Decoder for Apache HTTP Server access logs.
  compatibility: The Apache datasets were tested with Apache 2.4.12 and 2.4.46 and are expected to work with all versions >= 2.2.31 and >= 2.4.16 (independent from operating system).
  author:
    name: Wazuh Inc. info@wazuh.com
    date: 2022-11-15
  references:
    - https://httpd.apache.org/docs/2.4/logs.html

definitions:
  isSuccess: +t_is_not_null/http.response.status_code AND +i_lt/http.response.status_code/400
  isFailed: +t_is_not_null/http.response.status_code AND +i_ge/http.response.status_code/400
  isApacheAccess: +r_match/event.origina/\\S+\\s-\\s\\S+\\s\\[ OR +r_match/event.original/\\[[^\\]]+\\]\\s\\S+\\s\\S+\\s\\S+\\s\"
#    +r_match/event.origina/\S+\s-\s\S+\s\[ OR +r_match/event.original/\[[^\]]+\]\s\S+\s\S+\s\S+\s\"
check: $isApacheAccess
#check: +r_match/event.origina/\S+\s-\s\S+\s\[ OR +r_match/event.original/\[[^\]]+\]\s\S+\s\S+\s\S+\s\"

parse:
  logpar:
    - event.original: <source.address> - <user.name> [<@timestamp/26\/Dec\/2016:18:23:35 +0200>] "<~http.request>" <http.response.status_code> <~/literal/->?<http.response.body.bytes>(? "<http.request.referrer>" "<user_agent.original>")
    #    - event.original: <source.address> - <user.name> [<@timestamp/26\/Dec\/2016:18:23:35 +0200>] "-" <http.response.status_code> -
    #    - event.original: <source.address> - - [<@timestamp/%a %b %d %T %Y/en_US.UTF-8>] "-" <http.response.status_code> -
    - event.original: <destination.domain> <source.address> - <user.name> [<@timestamp/%a %b %d %T %Y/en_US.UTF-8>] "<~http.request>" <http.response.status_code> <~/literal/->?<http.response.body.bytes>(? "<http.request.referrer>" "<user_agent.original>")
    #   - event.original: <source.address> - - [<@timestamp/%a %b %d %T %Y/en_US.UTF-8>] "<http.request.method> <~url.orig> <http.version>?<~dash>" <http.response.status_code> <http.response.body.bytes>?<~dash> "<http.request.referrer>" "<user_agent.original>"
    #  - event.original: <source.address> - <user.name> [<@timestamp/%a %b %d %T %Y/en_US.UTF-8>] "<http.request.method> <~url.orig> <http.version>?<~dash>" <http.response.status_code> <http.response.body.bytes>?<~dash> "<http.request.referrer>" "<user_agent.original>"
    - event.original: '[<@timestamp/26\/Dec\/2016:18:23:35 +0200>] <source.address> <~apache.access.ssl.protocol> <tls.cipher> "<http.request.method> <~url.orig> <~http.version>" <http.response.body.bytes>?<~dash>'

normalize:
  - map:
      - ~dash: +ef_delete
      - event.category: +a_append/web
      - event.created: $@timestamp
      - event.dataset: apache.access
      - event.kind: event
      - event.module: apache
      - service.type: apache
      - source.ip: +parse_ip/$source.address
      - ~tls: +s_to_array/$~apache.access.ssl.protocol/v
      - ~tls-1: $~tls.1
      - tls.version_protocol: $~tls.0

    logpar:
      - ~http.request: <http.request.method> <url.original> <~http.version>
      - ~http.version: HTTP/<http.version>

  - check:
      - ~tls-1: +r_match/\d+\.\d+
    map:
      - tls.version: $~tls-1

  - check:
      - ~tls-1: +r_not_match/\d+\.\d+
    map:
      - tls.version: +s_concat/$~tls-1/.0

  - check: $isSuccess
    map:
      - event.outcome: success
  - check: $isFailed
    map:
      - event.outcome: failure

  - check:
      - source.ip: +ef_not_exists
    map:
      - source.domain: +parse_fqdn/$source.address

  - map:
      - url.extension: +r_ext/$url.original/.*\.([^.]+)$
      - ~http: +ef_delete
